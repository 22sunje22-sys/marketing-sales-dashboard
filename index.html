<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Platinumlist ‚Äî Paid Marketing Intelligence v2.5</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  /* Platinumlist B2B Brand Palette */
  --bg: #0A181C; --surface: #0f2229; --surface2: #162e36; --surface3: #1c3a44;
  --text: #e8edf0; --text2: #8fa8b4; --text3: #5d7a86;
  --accent: #79E2FF; --accent2: #00A5D3;
  --green: #C7F88A; --green-bg: rgba(199,248,138,0.12);
  --amber: #F59E0B; --amber-bg: rgba(245,158,11,0.12);
  --red: #EF4444; --red-bg: rgba(239,68,68,0.12);
  --blue: #79E2FF; --blue-bg: rgba(121,226,255,0.12);
  --purple: #8B5CF6; --purple-bg: rgba(139,92,246,0.12);
  --border: #1c3a44; --radius: 10px;
  /* Platinumlist brand colors */
  --pl-storm: #0A181C; --pl-monday: #79E2FF; --pl-day: #C7F88A;
  --pl-suede: #00A5D3; --pl-electro: #221327;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; -webkit-font-smoothing:antialiased; }

/* LOGIN */
.login-wrap { display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
.login-box { background:var(--surface); border-radius:16px; padding:40px; width:100%; max-width:380px; text-align:center; }
.login-box h1 { font-size:22px; margin-bottom:6px; }
.login-box p { color:var(--text2); font-size:13px; margin-bottom:24px; }
.login-box select, .login-box input { width:100%; padding:12px 16px; border-radius:8px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:14px; margin-bottom:12px; outline:none; }
.login-box button { width:100%; padding:12px; border-radius:8px; border:none; background:var(--pl-suede); color:#fff; font-size:15px; font-weight:600; cursor:pointer; transition:background 0.2s; }
.login-box button:hover { background:var(--pl-monday); color:var(--pl-storm); }
.login-err { color:var(--red); font-size:13px; margin-top:8px; display:none; }

/* APP */
.app { display:none; }
.topbar { background:var(--surface); border-bottom:1px solid var(--border); padding:12px 24px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
.topbar h2 { font-size:16px; font-weight:600; }
.topbar-right { display:flex; align-items:center; gap:12px; }
.user-badge { background:var(--surface2); padding:6px 14px; border-radius:20px; font-size:13px; color:var(--text2); }
.btn-logout { background:none; border:1px solid var(--border); color:var(--text2); padding:6px 14px; border-radius:20px; font-size:13px; cursor:pointer; }

/* TABS */
.tabs { display:flex; gap:2px; padding:0 24px; background:var(--surface); border-bottom:1px solid var(--border); overflow-x:auto; }
.tab { padding:12px 20px; font-size:13px; font-weight:500; color:var(--text2); cursor:pointer; border-bottom:2px solid transparent; white-space:nowrap; transition:all 0.2s; }
.tab:hover { color:var(--text); }
.tab.active { color:var(--pl-monday); border-bottom-color:var(--pl-monday); }

/* CONTENT */
.content { padding:20px 24px; max-width:1400px; margin:0 auto; }
.tab-pane { display:none; }
.tab-pane.active { display:block; }

/* KPI ROW */
.kpi-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-bottom:20px; }
.kpi { background:var(--surface); border-radius:var(--radius); padding:16px; }
.kpi-click { cursor:pointer; transition:background 0.2s,transform 0.15s; }
.kpi-click:hover { background:var(--surface2); transform:translateY(-2px); }
.kpi-label { font-size:11px; color:var(--text3); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; }
.kpi-val { font-size:24px; font-weight:700; }
.kpi-sub { font-size:12px; color:var(--text2); margin-top:2px; }

/* FILTERS */
.filter-bar { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; align-items:center; }
.filter-bar select { padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:13px; }
.filter-bar input { padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:13px; flex:1; min-width:200px; }

/* SMART CHIPS */
.chips { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:16px; }
.chip { padding:6px 14px; border-radius:20px; font-size:12px; font-weight:500; cursor:pointer; border:1px solid var(--border); background:var(--surface2); color:var(--text2); transition:all 0.2s; }
.chip:hover { border-color:var(--pl-monday); }
.chip.active { border-color:var(--pl-monday); background:var(--blue-bg); color:var(--pl-monday); }
.chip .cnt { margin-left:4px; opacity:0.7; }

/* VIEW CHIPS */
.view-chips { display:flex; gap:6px; margin-bottom:16px; }
.view-chip { padding:8px 18px; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; border:none; transition:all 0.2s; }
.vc-hot { background:var(--red-bg); color:var(--red); }
.vc-hot.active { background:var(--red); color:#fff; }
.vc-warm { background:var(--amber-bg); color:var(--amber); }
.vc-warm.active { background:var(--amber); color:#000; }
.vc-growth { background:var(--green-bg); color:var(--green); }
.vc-growth.active { background:var(--green); color:#fff; }
.vc-risk { background:var(--purple-bg); color:var(--purple); }
.vc-risk.active { background:var(--purple); color:#fff; }
.vc-all { background:var(--surface2); color:var(--text2); }
.vc-all.active { background:var(--pl-suede); color:#fff; }

/* CARDS */
.cards { display:grid; grid-template-columns:repeat(auto-fill,minmax(360px,1fr)); gap:12px; }
.card { background:var(--surface); border-radius:var(--radius); border:1px solid var(--border); overflow:hidden; transition:border-color 0.2s; }
.card:hover { border-color:var(--pl-suede); }
.card-head { display:flex; justify-content:space-between; align-items:flex-start; padding:14px 16px 10px; }
.card-name { font-size:14px; font-weight:600; max-width:70%; }
.card-badges { display:flex; gap:4px; flex-wrap:wrap; justify-content:flex-end; }
.badge { font-size:10px; padding:3px 8px; border-radius:12px; font-weight:600; white-space:nowrap; }
.badge-hot { background:var(--red-bg); color:var(--red); }
.badge-warm { background:var(--amber-bg); color:var(--amber); }
.badge-cold { background:var(--surface3); color:var(--text3); }
.badge-medium { background:var(--blue-bg); color:var(--blue); }
.badge-acc { background:var(--green-bg); color:var(--green); }
.badge-dec { background:var(--red-bg); color:var(--red); }
.badge-stable { background:var(--surface3); color:var(--text2); }

.card-meta { padding:0 16px 8px; display:flex; gap:8px; flex-wrap:wrap; }
.meta-pill { font-size:11px; color:var(--text3); background:var(--surface2); padding:2px 8px; border-radius:10px; }

.card-metrics { display:grid; grid-template-columns:repeat(3,1fr); gap:1px; background:var(--border); }
.cm { background:var(--surface); padding:10px 12px; text-align:center; }
.cm-label { font-size:10px; color:var(--text3); text-transform:uppercase; }
.cm-val { font-size:16px; font-weight:700; margin-top:2px; }
.cm-sub { font-size:10px; color:var(--text2); }

.card-action { padding:10px 16px; background:var(--surface2); display:flex; justify-content:space-between; align-items:center; }
.action-text { font-size:12px; font-weight:500; }
.action-icon { font-size:14px; }

.card-tags { padding:8px 16px 12px; display:flex; flex-wrap:wrap; gap:4px; }
.tag-sm { font-size:10px; padding:2px 7px; border-radius:8px; background:var(--surface3); color:var(--text2); }

/* CHARTS */
.chart-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:16px; margin-bottom:20px; }
.chart-box { background:var(--surface); border-radius:var(--radius); padding:16px; }
.chart-box h3 { font-size:14px; margin-bottom:12px; color:var(--text2); }
.chart-box canvas { max-height:280px; }

/* TABLE */
.tbl-wrap { overflow-x:auto; }
table { width:100%; border-collapse:collapse; font-size:13px; }
th { background:var(--surface2); padding:10px 12px; text-align:left; font-weight:600; color:var(--text2); white-space:nowrap; cursor:pointer; position:sticky; top:0; }
th:hover { color:var(--text); }
td { padding:8px 12px; border-bottom:1px solid var(--border); white-space:nowrap; }
tr:hover td { background:var(--surface2); }

/* PAGINATION */
.pag { display:flex; justify-content:space-between; align-items:center; padding:12px 0; }
.pag-info { font-size:13px; color:var(--text2); }
.pag-btns { display:flex; gap:6px; }
.pag-btn { padding:6px 14px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-size:13px; cursor:pointer; }
.pag-btn.active { background:var(--pl-suede); border-color:var(--pl-suede); color:#fff; }
.pag-btn:disabled { opacity:0.3; cursor:not-allowed; }

/* SEGMENTS */
.seg-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:16px; margin-bottom:20px; }
.seg-card { background:var(--surface); border-radius:var(--radius); padding:16px; }
.seg-card h3 { font-size:14px; margin-bottom:10px; }
.seg-row { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid var(--border); font-size:13px; }
.seg-row:last-child { border:none; }
.seg-click { cursor:pointer; padding:6px 4px; border-radius:4px; transition:background 0.2s; }
.seg-click:hover { background:var(--surface3); }

/* EXPORT BTN */
.btn-export { padding:8px 16px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-size:13px; cursor:pointer; white-space:nowrap; }
.btn-export:hover { background:var(--surface2); }

/* ASSIGN */
.assign-badge{ display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;background:var(--blue-bg);color:var(--blue); }
.assign-btn{ padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);font-size:12px;cursor:pointer; }
.assign-btn:hover{ background:var(--surface3); }

/* ACTION QUEUE */
.action-queue { background:var(--surface); border-radius:var(--radius); padding:16px; margin-bottom:20px; border:1px solid var(--border); }
.action-queue h3 { font-size:15px; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.aq-list { display:flex; flex-direction:column; gap:6px; }
.aq-item { display:flex; align-items:center; gap:12px; padding:10px 14px; border-radius:8px; background:var(--surface2); border-left:3px solid var(--amber); transition:background 0.2s; cursor:pointer; }
.aq-item:hover { background:var(--surface3); }
.aq-item.aq-hot { border-left-color:var(--red); }
.aq-item.aq-warm { border-left-color:var(--amber); }
.aq-item.aq-growth { border-left-color:var(--green); }
.aq-icon { font-size:18px; flex-shrink:0; }
.aq-body { flex:1; min-width:0; }
.aq-org { font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.aq-detail { font-size:11px; color:var(--text2); margin-top:2px; }
.aq-metric { text-align:right; flex-shrink:0; }
.aq-val { font-size:14px; font-weight:700; }
.aq-label { font-size:10px; color:var(--text3); }

/* TERRITORY SUMMARY */
.territory-bar { background:var(--surface); border-radius:var(--radius); padding:14px 18px; margin-bottom:16px; display:flex; align-items:center; gap:16px; flex-wrap:wrap; border:1px solid var(--border); }
.tb-item { display:flex; align-items:center; gap:6px; }
.tb-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.tb-text { font-size:12px; color:var(--text2); }
.tb-val { font-size:14px; font-weight:700; }

/* RESPONSIVE */
@media(max-width:768px) {
  .content { padding:12px; }
  .cards { grid-template-columns:1fr; }
  .chart-grid { grid-template-columns:1fr; }
  .kpi-row { grid-template-columns:repeat(2,1fr); }
  .tab { padding:10px 14px; font-size:12px; }
  .territory-bar { flex-direction:column; align-items:flex-start; }
}
@media(max-width:480px) {
  .kpi-row { grid-template-columns:1fr; }
  .card-metrics { grid-template-columns:repeat(2,1fr); }
}

/* ACHIEVEMENTS PANEL */
.ach-btn { background:var(--surface2); border:1px solid var(--border); color:var(--amber); padding:6px 14px; border-radius:20px; font-size:13px; cursor:pointer; position:relative; }
.ach-btn .ach-count { background:var(--amber); color:#000; font-size:10px; padding:1px 6px; border-radius:10px; margin-left:4px; font-weight:700; }
.ach-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:200; }
.ach-overlay.open { display:flex; align-items:center; justify-content:center; }
.ach-panel { background:var(--surface); border-radius:16px; width:95%; max-width:600px; max-height:80vh; overflow-y:auto; padding:24px; }
.ach-panel h2 { font-size:20px; margin-bottom:4px; }
.ach-panel .ach-sub { color:var(--text2); font-size:13px; margin-bottom:20px; }
.ach-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:10px; }
.ach-item { display:flex; align-items:center; gap:12px; padding:12px; border-radius:10px; background:var(--surface2); border:1px solid var(--border); transition:all 0.3s; }
.ach-item.locked { opacity:0.35; filter:grayscale(1); }
.ach-item.unlocked { border-color:var(--amber); }
.ach-item.just-unlocked { animation:achPop 0.6s ease; border-color:var(--amber); box-shadow:0 0 20px rgba(245,158,11,0.3); }
@keyframes achPop { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }
.ach-icon { font-size:28px; width:40px; text-align:center; flex-shrink:0; }
.ach-info { flex:1; }
.ach-title { font-size:13px; font-weight:600; }
.ach-desc { font-size:11px; color:var(--text2); margin-top:2px; }
.ach-time { font-size:10px; color:var(--text3); margin-top:2px; }

/* TOAST */
.toast-wrap { position:fixed; top:70px; right:20px; z-index:300; display:flex; flex-direction:column; gap:8px; }
.toast { background:var(--surface); border:1px solid var(--amber); border-radius:12px; padding:12px 18px; display:flex; align-items:center; gap:10px; animation:toastIn 0.4s ease, toastOut 0.4s ease 3.6s forwards; box-shadow:0 8px 24px rgba(0,0,0,0.4); }
@keyframes toastIn { from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1} }
@keyframes toastOut { from{opacity:1} to{opacity:0;transform:translateY(-20px)} }
.toast-icon { font-size:24px; }
.toast-text { font-size:13px; }
.toast-title { font-weight:600; color:var(--amber); }

/* ACTION BUTTONS ON CARDS */
.card-act-btns { display:flex; gap:4px; align-items:center; }
.act-btn { padding:4px 12px; border-radius:6px; border:1px solid var(--pl-suede); background:transparent; color:var(--pl-monday); font-size:11px; font-weight:600; cursor:pointer; transition:all 0.2s; white-space:nowrap; }
.act-btn:hover { background:var(--pl-suede); color:#fff; }
.act-btn-sm { padding:4px 6px; }
.act-done { font-size:14px; }
.vc-noact { background:var(--blue-bg); color:var(--pl-monday); }
.vc-noact.active { background:var(--pl-monday); color:var(--pl-storm); }
.vc-acted { background:var(--green-bg); color:var(--green); }
.vc-acted.active { background:var(--green); color:var(--pl-storm); }

/* ACTIVITY LOG TAB */
.log-table { width:100%; font-size:12px; }
.log-table th { padding:8px; text-align:left; color:var(--text2); border-bottom:1px solid var(--border); }
.log-table td { padding:6px 8px; border-bottom:1px solid var(--border); }
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-wrap" id="loginWrap">
<div class="login-box">
<div style="margin-bottom:16px;font-size:28px;font-weight:800;letter-spacing:-0.5px;color:var(--pl-monday);">Platinumlist</div>
<h1 style="font-size:18px;font-weight:600;">Paid Marketing Intelligence</h1>
<p>v2.5 ‚Äî for Organisers</p>
<select id="userSel">
<option value="">Select user...</option>
<option value="alex">Alex (All regions)</option>
<option value="taha">Taha (All regions)</option>
<option value="kamila">Kamila (UAE only)</option>
<option value="mohammed">Mohammed (Non-UAE)</option>
</select>
<input type="password" id="pwdInput" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()">
<button onclick="doLogin()">Sign In</button>
<div class="login-err" id="loginErr">Invalid password</div>
</div>
</div>

<!-- APP -->
<div class="app" id="app">
<div class="topbar">
<h2><span style="color:var(--pl-monday);font-weight:800;">Platinumlist</span> Marketing Intelligence</h2>
<div class="topbar-right">
<span class="user-badge" id="userBadge"></span>
<button class="ach-btn" onclick="toggleAch()">üèÜ <span id="achCountBadge" class="ach-count">0</span></button>
<button class="btn-logout" onclick="doLogout()">Logout</button>
</div>
</div>
<div class="tabs" id="tabsBar">
<div class="tab active" data-tab="overview">Overview</div>
<div class="tab" data-tab="pipeline">Pipeline</div>
<div class="tab" data-tab="opportunities">Opportunities</div>
<div class="tab" data-tab="performance">Performance</div>
<div class="tab" data-tab="organisers">üìä Organisers</div>
<div class="tab" data-tab="events">üé´ Events</div>
<div class="tab" data-tab="raw">Raw Data</div>
<div class="tab" data-tab="activity">üìã Activity</div>
</div>
<div class="content">
<div class="tab-pane active" id="pane-overview"></div>
<div class="tab-pane" id="pane-pipeline"></div>
<div class="tab-pane" id="pane-opportunities"></div>
<div class="tab-pane" id="pane-performance"></div>
<div class="tab-pane" id="pane-organisers"></div>
<div class="tab-pane" id="pane-events"></div>
<div class="tab-pane" id="pane-raw"></div>
<div class="tab-pane" id="pane-activity"></div>
</div>
</div>

<!-- ACHIEVEMENTS OVERLAY -->
<div class="ach-overlay" id="achOverlay" onclick="if(event.target===this)toggleAch()">
<div class="ach-panel">
<h2>üèÜ Achievements</h2>
<div class="ach-sub" id="achSub">0 / 20 unlocked</div>
<div class="ach-grid" id="achGrid"></div>
</div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-wrap" id="toastWrap"></div>

<script>
let RAW_ORGS=[], RAW_EVENTS=[];
let dataLoaded=false;
async function loadData(){
  const base=window.location.origin;
  try{
    const [orgsRes,eventsRes]=await Promise.all([
      fetch(base+'/api/orgs'),
      fetch(base+'/api/events')
    ]);
    if(!orgsRes.ok||!eventsRes.ok)throw new Error('API error');
    RAW_ORGS=await orgsRes.json();
    RAW_EVENTS=await eventsRes.json();
    dataLoaded=true;
  }catch(e){
    console.error('Failed to load data:',e);
    // Fallback: try Supabase direct
    const sb=window.supabase.createClient('https://kwftlkfvtglnugxsyjci.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3ZnRsa2Z2dGdsbnVneHN5amNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2NDAxODUsImV4cCI6MjA2MzIxNjE4NX0.9Cn1xahmF8q6pbbWQHNyQSc9fZkVvJaqTzMRZCtmb9E');
    const {data:o1}=await sb.from('dashboard_organisers').select('*').range(0,999);
    const {data:o2}=await sb.from('dashboard_organisers').select('*').range(1000,1999);
    RAW_ORGS=[...(o1||[]),...(o2||[])];
    let allEvts=[];let from=0;
    while(true){const{data}=await sb.from('dashboard_events').select('*').range(from,from+999);if(!data||data.length===0)break;allEvts=allEvts.concat(data);from+=1000;}
    // Map event_id -> id for compatibility
    RAW_EVENTS=allEvts.map(r=>({org:r.org,name:r.name,country:r.country,type:r.type,id:r.event_id,date:r.date,year:r.year,rev:r.rev,mkt:r.mkt,share:r.share}));
    dataLoaded=true;
  }
}
const PWD='salesdash';
const USERS={alex:{name:'Alex',filter:null},taha:{name:'Taha',filter:null},kamila:{name:'Kamila',filter:'United Arab Emirates',mode:'only'},mohammed:{name:'Mohammed',filter:'United Arab Emirates',mode:'exclude'}};

let curUser=null, ORGS=[], EVENTS=[], charts={};
let orgAssign={}, evtAssign={};
let ORG_ACTIONS=[], ORG_ACTIONS_SET=new Set();
async function loadActions(){
  try{
    const res=await fetch(window.location.origin+'/api/actions');
    if(res.ok){ORG_ACTIONS=await res.json();ORG_ACTIONS_SET=new Set(ORG_ACTIONS.map(a=>a.org));}
  }catch(e){console.warn('Actions load failed',e);}
}
async function logOrgAction(org,action,note){
  if(!curUser)return;
  try{
    const res=await fetch(window.location.origin+'/api/actions',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({org,action:action||'worked_on',user_name:curUser.name,note:note||null})});
    if(res.ok){const a=await res.json();ORG_ACTIONS.unshift(a);ORG_ACTIONS_SET.add(org);renderOppCards();showToast('‚úÖ','Logged',`"${action||'Worked on it'}" for ${org}`);}
  }catch(e){console.error('Action log failed',e);}
}
let orgListPage=0, orgListSort={col:'ps',asc:false}, orgListSearch='';
let evtListPage=0, evtListSort={col:'rev',asc:false}, evtListSearch='';

/* FORMATTERS */
const fmt=n=>{if(n==null)return'-';if(Math.abs(n)>=1e6)return(n/1e6).toFixed(1)+'M';if(Math.abs(n)>=1e3)return(n/1e3).toFixed(1)+'K';return n.toFixed?n.toFixed(0):n;};
const fmtPct=n=>n!=null?(n>0?'+':'')+n.toFixed(1)+'%':'-';
const fmtCur=n=>{if(n==null)return'-';if(Math.abs(n)>=1e9)return'AED '+(n/1e9).toFixed(1)+'B';if(Math.abs(n)>=1e6)return'AED '+(n/1e6).toFixed(1)+'M';if(Math.abs(n)>=1e3)return'AED '+(n/1e3).toFixed(0)+'K';return'AED '+Math.round(n);};

/* LOGIN */
async function doLogin(){
  const u=document.getElementById('userSel').value;
  const p=document.getElementById('pwdInput').value;
  if(!u||p!==PWD){document.getElementById('loginErr').style.display='block';return;}
  const btn=document.querySelector('.login-box button');
  btn.textContent='Loading data...';btn.disabled=true;
  if(!dataLoaded)await loadData();
  await loadActions();
  btn.textContent='Sign In';btn.disabled=false;
  if(!dataLoaded){document.getElementById('loginErr').textContent='Failed to load data';document.getElementById('loginErr').style.display='block';return;}
  curUser=USERS[u];curUser.id=u;
  sess={tabs:new Set(),filters:0,searches:0,exports:0,orgsViewed:0,loginTime:new Date(),actions:[]};
  userAch=new Set();
  initData();
  document.getElementById('loginWrap').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('userBadge').textContent=curUser.name+(curUser.filter?(' ‚Ä¢ '+(curUser.mode==='only'?curUser.filter:'Non-'+curUser.filter)):'');
  logVisit();logAction('login','logged in','');loadAchievements();
  switchTab('overview');
}
function doLogout(){
  document.getElementById('app').style.display='none';
  document.getElementById('loginWrap').style.display='flex';
  document.getElementById('pwdInput').value='';
  Object.values(charts).forEach(c=>{if(c&&c.destroy)c.destroy();});charts={};
}

function initData(){
  ORGS=RAW_ORGS.filter(o=>{
    if(!curUser.filter)return true;
    return curUser.mode==='only'?o.country===curUser.filter:o.country!==curUser.filter;
  });
  EVENTS=RAW_EVENTS.filter(e=>{
    if(!curUser.filter)return true;
    return curUser.mode==='only'?e.country===curUser.filter:e.country!==curUser.filter;
  });
}

/* TABS */
document.getElementById('tabsBar').addEventListener('click',e=>{
  if(e.target.classList.contains('tab'))switchTab(e.target.dataset.tab);
});
function switchTab(t){
  document.querySelectorAll('.tab').forEach(el=>el.classList.toggle('active',el.dataset.tab===t));
  document.querySelectorAll('.tab-pane').forEach(el=>el.classList.toggle('active',el.id==='pane-'+t));
  Object.values(charts).forEach(c=>{if(c&&c.destroy)c.destroy();});charts={};
  sess.tabs.add(t);
  logAction('switch_tab',t,t);
  if(t==='overview')renderOverview();
  else if(t==='pipeline')renderPipeline();
  else if(t==='opportunities')renderOpps();
  else if(t==='performance')renderPerf();
  else if(t==='organisers')renderOrganisers();
  else if(t==='events')renderEvents();
  else if(t==='raw')renderRaw();
  else if(t==='activity')renderActivity();
}
function drillDown(view,searchTerm){
  oppView=view||'all';oppPage=0;oppFilters={country:'',tier:'',stage:'',type:'',search:searchTerm||'',tag:''};
  switchTab('opportunities');
}

/* ===== OVERVIEW TAB ===== */
function renderOverview(){
  const p=document.getElementById('pane-overview');
  const totalTick=ORGS.reduce((s,o)=>s+o.tt,0);
  const totalMkt=ORGS.reduce((s,o)=>s+o.tm,0);
  const avgShare=totalTick>0?(totalMkt/totalTick*100):0;
  const totalRP=ORGS.reduce((s,o)=>s+(o.rp||0),0);
  const hotCount=ORGS.filter(o=>o.sr==='hot').length;
  const warmCount=ORGS.filter(o=>o.sr==='warm').length;
  const atRisk=ORGS.filter(o=>o.lc==='at-risk').length;
  const growing=ORGS.filter(o=>o.gt==='accelerating').length;

  // Territory summary
  const countries={};ORGS.forEach(o=>{if(!countries[o.country])countries[o.country]={cnt:0,rev:0};countries[o.country].cnt++;countries[o.country].rev+=o.tt;});
  const topCountries=Object.entries(countries).sort((a,b)=>b[1].rev-a[1].rev).slice(0,5);
  const territoryHtml=curUser.filter?`<div class="territory-bar"><div class="tb-item"><span style="font-size:14px">üìç</span><span class="tb-text"><b>${curUser.name}</b> ‚Äî ${curUser.mode==='only'?curUser.filter:'GCC (Non-UAE)'}</span></div><div class="tb-item"><div class="tb-dot" style="background:var(--accent2)"></div><span class="tb-text">${ORGS.length} orgs</span></div><div class="tb-item"><div class="tb-dot" style="background:var(--green)"></div><span class="tb-text">${fmtCur(totalTick)} ticketing</span></div><div class="tb-item"><div class="tb-dot" style="background:var(--amber)"></div><span class="tb-text">${hotCount+warmCount} hot/warm leads</span></div></div>`:`<div class="territory-bar"><div class="tb-item"><span style="font-size:14px">üåç</span><span class="tb-text"><b>${curUser.name}</b> ‚Äî All Regions</span></div>${topCountries.map(([c,d])=>`<div class="tb-item"><div class="tb-dot" style="background:var(--accent2)"></div><span class="tb-text">${c}: ${d.cnt} orgs (${fmtCur(d.rev)})</span></div>`).join('')}</div>`;

  // Priority Actions queue ‚Äî top 8 most urgent
  const actionQueue=[...ORGS].filter(o=>o.sr==='hot'||o.rs>60||o.gt==='decelerating').sort((a,b)=>{const aPri=(a.sr==='hot'?30:0)+(a.rs>60?a.rs*0.3:0)+(a.gt==='decelerating'?20:0)+a.ps*0.2;const bPri=(b.sr==='hot'?30:0)+(b.rs>60?b.rs*0.3:0)+(b.gt==='decelerating'?20:0)+b.ps*0.2;return bPri-aPri;}).slice(0,8);
  const aqIcons={Upsell:'üí∞',Retain:'üõ°Ô∏è',Acquire:'üéØ',Pitch:'üìû',Accelerate:'üöÄ',Expand:'üìà',Grow:'üå±',Defend:'‚öîÔ∏è',Engage:'ü§ù',Monitor:'üëÅÔ∏è'};

  p.innerHTML=`
  ${territoryHtml}
  <div class="kpi-row">
    <div class="kpi"><div class="kpi-label">Total Ticketing Revenue</div><div class="kpi-val">${fmtCur(totalTick)}</div><div class="kpi-sub">${ORGS.length} organisers</div></div>
    <div class="kpi"><div class="kpi-label">Total Mkt Revenue</div><div class="kpi-val">${fmtCur(totalMkt)}</div><div class="kpi-sub">${avgShare.toFixed(1)}% avg share</div></div>
    <div class="kpi"><div class="kpi-label">Revenue Potential</div><div class="kpi-val" style="color:var(--green)">${fmtCur(totalRP)}</div><div class="kpi-sub">Uplift if at benchmark</div></div>
    <div class="kpi kpi-click" onclick="drillDown('hot')" title="View Hot prospects"><div class="kpi-label">üî• Hot Prospects</div><div class="kpi-val" style="color:var(--red)">${hotCount}</div><div class="kpi-sub">${warmCount} warm leads</div></div>
    <div class="kpi kpi-click" onclick="drillDown('risk')" title="View At Risk orgs"><div class="kpi-label">‚ö†Ô∏è At Risk</div><div class="kpi-val" style="color:var(--amber)">${atRisk}</div><div class="kpi-sub">Need attention</div></div>
    <div class="kpi kpi-click" onclick="drillDown('growth')" title="View Growing orgs"><div class="kpi-label">üöÄ Growing</div><div class="kpi-val" style="color:var(--green)">${growing}</div><div class="kpi-sub">Accelerating orgs</div></div>
  </div>
  <div class="action-queue">
    <h3>‚ö° Priority Actions Today</h3>
    <div class="aq-list">
      ${actionQueue.map(o=>{
        const action=o.nba.split('‚Äî')[0].trim();
        const detail=o.nba.split('‚Äî').slice(1).join('‚Äî').trim();
        const icon=aqIcons[action]||'‚ö°';
        const cls=o.sr==='hot'?'aq-hot':o.rs>60?'aq-warm':'aq-growth';
        return`<div class="aq-item ${cls}" onclick="drillDown('all','${o.organizer.replace(/'/g,"\\'")}')" title="Click to view in Opportunities"><div class="aq-icon">${icon}</div><div class="aq-body"><div class="aq-org">${o.organizer}</div><div class="aq-detail">${action}: ${detail} ¬∑ ${o.country} ¬∑ ${o.tier}</div></div><div class="aq-metric"><div class="aq-val" style="color:var(--green)">${fmtCur(o.rp)}</div><div class="aq-label">potential</div></div></div>`;
      }).join('')}
    </div>
  </div>
  <div class="chart-grid">
    <div class="chart-box"><h3>Revenue Trend (Ticketing vs Marketing)</h3><canvas id="chRevTrend"></canvas></div>
    <div class="chart-box"><h3>Sales Readiness Distribution</h3><canvas id="chReadiness"></canvas></div>
    <div class="chart-box"><h3>Lifecycle Stage Breakdown</h3><canvas id="chLifecycle"></canvas></div>
    <div class="chart-box"><h3>Growth Trajectory</h3><canvas id="chTrajectory"></canvas></div>
  </div>
  <div class="seg-grid">
    <div class="seg-card"><h3>Top 5 by Priority Score</h3><div id="segTop5PS"></div></div>
    <div class="seg-card"><h3>Top 5 Revenue Potential</h3><div id="segTop5RP"></div></div>
    <div class="seg-card"><h3>Biggest Declines (YoY)</h3><div id="segDeclines"></div></div>
    <div class="seg-card"><h3>Fastest Growing</h3><div id="segGrowing"></div></div>
  </div>`;

  // Revenue Trend
  const years=[2023,2024,2025,2026];
  const tickByYear=years.map(y=>ORGS.reduce((s,o)=>s+(o['t'+(y-2000)]||0),0));
  const mktByYear=years.map(y=>ORGS.reduce((s,o)=>s+(o['m'+(y-2000)]||0),0));
  charts.revTrend=new Chart(document.getElementById('chRevTrend'),{type:'bar',data:{labels:years,datasets:[
    {label:'Ticketing',data:tickByYear,backgroundColor:'rgba(59,130,246,0.7)',borderRadius:4},
    {label:'Marketing',data:mktByYear,backgroundColor:'rgba(16,185,129,0.7)',borderRadius:4}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8fa8b4'}}},scales:{x:{ticks:{color:'#5d7a86'}},y:{ticks:{color:'#5d7a86',callback:v=>fmtCur(v)}}}}});

  // Readiness donut
  const readCounts={};ORGS.forEach(o=>{readCounts[o.sr]=(readCounts[o.sr]||0)+1;});
  const srKeys=Object.keys(readCounts);
  charts.readiness=new Chart(document.getElementById('chReadiness'),{type:'doughnut',data:{labels:srKeys.map(k=>k.charAt(0).toUpperCase()+k.slice(1)),datasets:[{data:Object.values(readCounts),backgroundColor:['#EF4444','#F59E0B','#6b7280','#79E2FF']}]},options:{responsive:true,maintainAspectRatio:false,onClick:(e,els)=>{if(els.length>0){drillDown('sr_'+srKeys[els[0].index]);}},plugins:{legend:{position:'right',labels:{color:'#8fa8b4'}},tooltip:{callbacks:{afterLabel:()=>'Click to drill down'}}}}});
  document.getElementById('chReadiness').style.cursor='pointer'; 

  // Lifecycle donut
  const lcCounts={};ORGS.forEach(o=>{lcCounts[o.lc]=(lcCounts[o.lc]||0)+1;});
  const lcColors={prospect:'#F59E0B',active:'#79E2FF',growth:'#C7F88A','at-risk':'#EF4444',mature:'#8B5CF6',dormant:'#6b7280'};
  const lcKeys=Object.keys(lcCounts);
  charts.lifecycle=new Chart(document.getElementById('chLifecycle'),{type:'doughnut',data:{labels:lcKeys.map(k=>k.charAt(0).toUpperCase()+k.slice(1)),datasets:[{data:Object.values(lcCounts),backgroundColor:lcKeys.map(k=>lcColors[k]||'#6b7280')}]},options:{responsive:true,maintainAspectRatio:false,onClick:(e,els)=>{if(els.length>0){drillDown('lc_'+lcKeys[els[0].index]);}},plugins:{legend:{position:'right',labels:{color:'#8fa8b4'}},tooltip:{callbacks:{afterLabel:()=>'Click to drill down'}}}}});
  document.getElementById('chLifecycle').style.cursor='pointer'; 

  // Trajectory bar
  const gtCounts={};ORGS.forEach(o=>{gtCounts[o.gt]=(gtCounts[o.gt]||0)+1;});
  const gtColors={accelerating:'#C7F88A',stable:'#79E2FF',decelerating:'#EF4444',mixed:'#F59E0B'};
  const gtKeys=Object.keys(gtCounts);
  charts.trajectory=new Chart(document.getElementById('chTrajectory'),{type:'bar',data:{labels:gtKeys.map(k=>k.charAt(0).toUpperCase()+k.slice(1)),datasets:[{data:Object.values(gtCounts),backgroundColor:gtKeys.map(k=>gtColors[k]||'#6b7280'),borderRadius:6}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,onClick:(e,els)=>{if(els.length>0){drillDown('traj_'+gtKeys[els[0].index]);}},plugins:{legend:{display:false},tooltip:{callbacks:{afterLabel:()=>'Click to drill down'}}},scales:{x:{ticks:{color:'#5d7a86'}},y:{ticks:{color:'#8fa8b4'}}}}});
  document.getElementById('chTrajectory').style.cursor='pointer'; 

  // Segments
  const top5ps=[...ORGS].sort((a,b)=>b.ps-a.ps).slice(0,5);
  document.getElementById('segTop5PS').innerHTML=top5ps.map(o=>`<div class="seg-row seg-click" onclick="drillDown('all','${o.organizer.replace(/'/g,"\\'")}')" title="View in Opportunities"><span>${o.organizer.substring(0,35)}</span><span><b>${o.ps}</b> score</span></div>`).join('');
  const top5rp=[...ORGS].sort((a,b)=>b.rp-a.rp).slice(0,5);
  document.getElementById('segTop5RP').innerHTML=top5rp.map(o=>`<div class="seg-row seg-click" onclick="drillDown('all','${o.organizer.replace(/'/g,"\\'")}')" title="View in Opportunities"><span>${o.organizer.substring(0,35)}</span><span style="color:var(--green)">${fmtCur(o.rp)}</span></div>`).join('');
  const declines=[...ORGS].filter(o=>o.tyoy25<0).sort((a,b)=>a.tyoy25-b.tyoy25).slice(0,5);
  document.getElementById('segDeclines').innerHTML=declines.map(o=>`<div class="seg-row seg-click" onclick="drillDown('all','${o.organizer.replace(/'/g,"\\'")}')" title="View in Opportunities"><span>${o.organizer.substring(0,35)}</span><span style="color:var(--red)">${fmtPct(o.tyoy25)}</span></div>`).join('');
  const growers=[...ORGS].filter(o=>o.myoy25>0).sort((a,b)=>b.myoy25-a.myoy25).slice(0,5);
  document.getElementById('segGrowing').innerHTML=growers.map(o=>`<div class="seg-row seg-click" onclick="drillDown('all','${o.organizer.replace(/'/g,"\\'")}')" title="View in Opportunities"><span>${o.organizer.substring(0,35)}</span><span style="color:var(--green)">${fmtPct(o.myoy25)}</span></div>`).join('');
}

/* ===== PIPELINE TAB ===== */
function renderPipeline(){
  const p=document.getElementById('pane-pipeline');
  // Group by lifecycle
  const stages=['growth','active','prospect','at-risk','mature','dormant'];
  const stageLabels={growth:'üöÄ Growth',active:'‚úÖ Active',prospect:'üéØ Prospect','at-risk':'‚ö†Ô∏è At Risk',mature:'üíé Mature',dormant:'üí§ Dormant'};
  const stageColors={growth:'var(--green)',active:'var(--blue)',prospect:'var(--amber)','at-risk':'var(--red)',mature:'var(--purple)',dormant:'var(--text3)'};

  let html='<div class="kpi-row">';
  stages.forEach(s=>{
    const list=ORGS.filter(o=>o.lc===s);
    const rp=list.reduce((sum,o)=>sum+(o.rp||0),0);
    html+=`<div class="kpi kpi-click" onclick="drillDown('lc_${s}')" title="View ${s} orgs in Opportunities"><div class="kpi-label">${stageLabels[s]||s}</div><div class="kpi-val" style="color:${stageColors[s]}">${list.length}</div><div class="kpi-sub">${fmtCur(rp)} potential</div></div>`;
  });
  html+='</div>';

  // Pipeline funnel-style breakdown
  html+='<div class="seg-grid">';
  stages.forEach(s=>{
    const list=ORGS.filter(o=>o.lc===s).sort((a,b)=>b.rp-a.rp).slice(0,8);
    html+=`<div class="seg-card"><h3>${stageLabels[s]} ‚Äî Top 8</h3>`;
    list.forEach(o=>{
      const srBadge=o.sr==='hot'?'badge-hot':o.sr==='warm'?'badge-warm':'badge-medium';
      html+=`<div class="seg-row seg-click" onclick="drillDown('all','${o.organizer.replace(/'/g,"\\'")}')" title="View in Opportunities"><span>${o.organizer.substring(0,30)} <span class="badge ${srBadge}">${o.sr}</span></span><span>${fmtCur(o.rp)}</span></div>`;
    });
    html+='</div>';
  });
  html+='</div>';

  // Action breakdown
  const actionCounts={};ORGS.forEach(o=>{const a=o.nba.split('‚Äî')[0].trim();actionCounts[a]=(actionCounts[a]||0)+1;});
  html+=`<div class="chart-grid"><div class="chart-box"><h3>Next Best Actions Distribution</h3><canvas id="chActions"></canvas></div>
  <div class="chart-box"><h3>Priority Score vs Revenue Potential (Top 50)</h3><canvas id="chScatter"></canvas></div></div>`;

  p.innerHTML=html;

  // Actions chart
  const actionLabels=Object.keys(actionCounts);
  const actionColors=['#C7F88A','#F59E0B','#EF4444','#79E2FF','#8B5CF6','#EC4899','#6366F1','#14B8A6','#F97316','#6b7280'];
  charts.actions=new Chart(document.getElementById('chActions'),{type:'bar',data:{labels:actionLabels,datasets:[{data:Object.values(actionCounts),backgroundColor:actionColors.slice(0,actionLabels.length),borderRadius:6}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#5d7a86'}},y:{ticks:{color:'#8fa8b4',font:{size:11}}}}}}); 

  // Scatter: Priority vs Revenue Potential
  const top50=[...ORGS].sort((a,b)=>b.ps-a.ps).slice(0,50);
  const scatterData=top50.map(o=>({x:o.ps,y:o.rp,label:o.organizer}));
  charts.scatter=new Chart(document.getElementById('chScatter'),{type:'scatter',data:{datasets:[{data:scatterData,backgroundColor:top50.map(o=>o.sr==='hot'?'#EF4444':o.sr==='warm'?'#F59E0B':'#79E2FF'),pointRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`${scatterData[ctx.dataIndex].label}: PS=${ctx.parsed.x}, RP=${fmtCur(ctx.parsed.y)}`}}},scales:{x:{title:{display:true,text:'Priority Score',color:'#8fa8b4'},ticks:{color:'#5d7a86'}},y:{title:{display:true,text:'Revenue Potential',color:'#8fa8b4'},ticks:{color:'#5d7a86',callback:v=>fmtCur(v)}}}}});
}

/* ===== OPPORTUNITIES TAB ===== */
let oppPage=0,oppView='all',oppFilters={country:'',tier:'',stage:'',type:'',search:'',tag:''};
function renderOpps(){
  const p=document.getElementById('pane-opportunities');
  const countries=[...new Set(ORGS.map(o=>o.country))].sort();
  const tiers=[...new Set(ORGS.map(o=>o.tier))].sort();
  const stages=[...new Set(ORGS.map(o=>o.stage))].sort();
  const types=[...new Set(ORGS.map(o=>o.type))].filter(Boolean).sort();

  // Tag counts for chips
  const tagCounts={};ORGS.forEach(o=>o.tags.forEach(t=>{tagCounts[t]=(tagCounts[t]||0)+1;}));
  const TAG_META={'low-share-opportunity':{l:'Low Share Big Rev',i:'üìà'},'high-share':{l:'High Share',i:'‚≠ê'},'fast-growing':{l:'Fast Growing',i:'üöÄ'},'declining':{l:'Declining',i:'üìâ'},'zero-mkt':{l:'Zero Marketing',i:'üî¥'},'untapped-big':{l:'Untapped Big',i:'üíé'},'premier-low-share':{l:'Premier Low Share',i:'üëë'},'call-today':{l:'Call Today',i:'üìû'},'scaling':{l:'Scaling',i:'üìà'},'defend-now':{l:'Defend Now',i:'üõ°Ô∏è'},'whale-prospect':{l:'Whale Prospect',i:'üêã'}};

  let html=`
  <div class="view-chips">
    <div class="view-chip vc-all ${oppView==='all'?'active':''}" onclick="oppView='all';oppPage=0;renderOppCards()">All (${ORGS.length})</div>
    <div class="view-chip vc-hot ${oppView==='hot'?'active':''}" onclick="oppView='hot';oppPage=0;logAction('view_filter','hot','opportunities');renderOppCards()">üî• Hot (${ORGS.filter(o=>o.sr==='hot').length})</div>
    <div class="view-chip vc-warm ${oppView==='warm'?'active':''}" onclick="oppView='warm';oppPage=0;logAction('view_filter','warm','opportunities');renderOppCards()">üü° Warm (${ORGS.filter(o=>o.sr==='warm').length})</div>
    <div class="view-chip vc-growth ${oppView==='growth'?'active':''}" onclick="oppView='growth';oppPage=0;logAction('view_filter','growth','opportunities');renderOppCards()">üöÄ Growing (${ORGS.filter(o=>o.gt==='accelerating').length})</div>
    <div class="view-chip vc-risk ${oppView==='risk'?'active':''}" onclick="oppView='risk';oppPage=0;logAction('view_filter','risk','opportunities');renderOppCards()">‚ö†Ô∏è At Risk (${ORGS.filter(o=>o.rs>60).length})</div>
    <div class="view-chip vc-noact ${oppView==='no_actions'?'active':''}" onclick="oppView='no_actions';oppPage=0;renderOppCards()">üÜï Without Actions (${ORGS.filter(o=>!ORG_ACTIONS_SET.has(o.organizer)).length})</div>
    <div class="view-chip vc-acted ${oppView==='acted'?'active':''}" onclick="oppView='acted';oppPage=0;renderOppCards()">‚úÖ Worked On (${ORGS.filter(o=>ORG_ACTIONS_SET.has(o.organizer)).length})</div>
    ${oppView.startsWith('traj_')?`<div class="view-chip active" style="background:var(--accent);color:var(--pl-storm);" onclick="oppView='all';oppPage=0;renderOppCards()">üìä ${oppView.replace('traj_','').charAt(0).toUpperCase()+oppView.replace('traj_','').slice(1)} (${ORGS.filter(o=>o.gt===oppView.replace('traj_','')).length}) ‚úï</div>`:''}
    ${oppView.startsWith('sr_')?`<div class="view-chip active" style="background:var(--accent);color:var(--pl-storm);" onclick="oppView='all';oppPage=0;renderOppCards()">üéØ ${oppView.replace('sr_','').charAt(0).toUpperCase()+oppView.replace('sr_','').slice(1)} Readiness (${ORGS.filter(o=>o.sr===oppView.replace('sr_','')).length}) ‚úï</div>`:''}
    ${oppView.startsWith('lc_')?`<div class="view-chip active" style="background:var(--accent);color:var(--pl-storm);" onclick="oppView='all';oppPage=0;renderOppCards()">üîÑ ${oppView.replace('lc_','').charAt(0).toUpperCase()+oppView.replace('lc_','').slice(1)} Lifecycle (${ORGS.filter(o=>o.lc===oppView.replace('lc_','')).length}) ‚úï</div>`:''}
  </div>
  <div class="filter-bar">
    <select onchange="oppFilters.country=this.value;oppPage=0;sess.filters++;logAction('filter_country',this.value,'opportunities');renderOppCards()"><option value="">All Countries</option>${countries.map(c=>`<option value="${c}">${c}</option>`).join('')}</select>
    <select onchange="oppFilters.tier=this.value;oppPage=0;sess.filters++;logAction('filter_tier',this.value,'opportunities');renderOppCards()"><option value="">All Tiers</option>${tiers.map(t=>`<option value="${t}">${t}</option>`).join('')}</select>
    <select onchange="oppFilters.stage=this.value;oppPage=0;sess.filters++;logAction('filter_stage',this.value,'opportunities');renderOppCards()"><option value="">All Stages</option>${stages.map(s=>`<option value="${s}">${s}</option>`).join('')}</select>
    <select onchange="oppFilters.type=this.value;oppPage=0;sess.filters++;logAction('filter_type',this.value,'opportunities');renderOppCards()"><option value="">All Types</option>${types.map(t=>`<option value="${t}">${t}</option>`).join('')}</select>
    <input placeholder="Search organisers..." oninput="oppFilters.search=this.value.toLowerCase();oppPage=0;sess.searches++;renderOppCards()" onchange="logAction('search',this.value,'opportunities')">
    <button class="btn-export" onclick="sess.exports++;logAction('export','csv_filtered','opportunities');exportCSV()">üì• Export CSV</button>
  </div>
  <div class="chips">${Object.entries(TAG_META).filter(([k])=>tagCounts[k]).map(([k,v])=>`<div class="chip ${oppFilters.tag===k?'active':''}" onclick="oppFilters.tag=oppFilters.tag==='${k}'?'':'${k}';oppPage=0;logAction('filter_tag','${k}','opportunities');renderOppCards();this.classList.toggle('active')">${v.i} ${v.l} <span class="cnt">${tagCounts[k]||0}</span></div>`).join('')}</div>
  <div id="oppCards"></div>
  <div class="pag" id="oppPag"></div>`;

  p.innerHTML=html;
  renderOppCards();
}

function getFilteredOrgs(){
  let list=ORGS;
  if(oppView==='hot')list=list.filter(o=>o.sr==='hot');
  else if(oppView==='warm')list=list.filter(o=>o.sr==='warm');
  else if(oppView==='growth')list=list.filter(o=>o.gt==='accelerating');
  else if(oppView==='risk')list=list.filter(o=>o.rs>60);
  else if(oppView==='no_actions')list=list.filter(o=>!ORG_ACTIONS_SET.has(o.organizer));
  else if(oppView==='acted')list=list.filter(o=>ORG_ACTIONS_SET.has(o.organizer));
  else if(oppView.startsWith('traj_'))list=list.filter(o=>o.gt===oppView.replace('traj_',''));
  else if(oppView.startsWith('sr_'))list=list.filter(o=>o.sr===oppView.replace('sr_',''));
  else if(oppView.startsWith('lc_'))list=list.filter(o=>o.lc===oppView.replace('lc_',''));

  if(oppFilters.country)list=list.filter(o=>o.country===oppFilters.country);
  if(oppFilters.tier)list=list.filter(o=>o.tier===oppFilters.tier);
  if(oppFilters.stage)list=list.filter(o=>o.stage===oppFilters.stage);
  if(oppFilters.type)list=list.filter(o=>o.type===oppFilters.type);
  if(oppFilters.search)list=list.filter(o=>o.organizer.toLowerCase().includes(oppFilters.search));
  if(oppFilters.tag)list=list.filter(o=>o.tags.includes(oppFilters.tag));

  return list.sort((a,b)=>b.ps-a.ps);
}

function renderOppCards(){
  const list=getFilteredOrgs();
  const perPage=20;
  const start=oppPage*perPage;
  const page=list.slice(start,start+perPage);
  const totalPages=Math.ceil(list.length/perPage);

  const srCls={hot:'badge-hot',warm:'badge-warm',cold:'badge-cold',medium:'badge-medium'};
  const gtCls={accelerating:'badge-acc',decelerating:'badge-dec',stable:'badge-stable',mixed:'badge-warm'};
  const gtLabel={accelerating:'‚Üó Accelerating',decelerating:'‚Üò Decelerating',stable:'‚Üí Stable',mixed:'‚Üó‚Üò Mixed'};
  const actionColor=nba=>{const a=nba.split('‚Äî')[0].trim();return{Upsell:'var(--green)',Retain:'var(--red)',Acquire:'var(--amber)',Pitch:'var(--blue)',Accelerate:'var(--green)',Expand:'var(--purple)',Grow:'var(--blue)',Defend:'var(--red)',Engage:'var(--accent2)',Monitor:'var(--text3)'}[a]||'var(--text2)';};

  let html='<div class="cards">';
  page.forEach(o=>{
    html+=`<div class="card">
      <div class="card-head">
        <div class="card-name">${o.organizer}</div>
        <div class="card-badges">
          <span class="badge ${srCls[o.sr]||''}">${o.sr.toUpperCase()}</span>
          <span class="badge ${gtCls[o.gt]||''}">${gtLabel[o.gt]||o.gt}</span>
        </div>
      </div>
      <div class="card-meta">
        <span class="meta-pill">${o.country}</span>
        <span class="meta-pill">${o.tier}</span>
        <span class="meta-pill">${o.stage}</span>
        ${o.type?`<span class="meta-pill">${o.type}</span>`:''}
        <span class="meta-pill">${o.lc}</span>
      </div>
      <div class="card-metrics">
        <div class="cm"><div class="cm-label">Priority</div><div class="cm-val" style="color:${o.ps>=70?'var(--green)':o.ps>=50?'var(--amber)':'var(--text2)'}">${o.ps}</div><div class="cm-sub">/ 100</div></div>
        <div class="cm"><div class="cm-label">Rev Potential</div><div class="cm-val" style="color:var(--green)">${fmtCur(o.rp)}</div><div class="cm-sub">12M uplift</div></div>
        <div class="cm"><div class="cm-label">Risk</div><div class="cm-val" style="color:${o.rs>70?'var(--red)':o.rs>40?'var(--amber)':'var(--green)'}">${o.rs}</div><div class="cm-sub">/ 100</div></div>
        <div class="cm"><div class="cm-label">Ticketing</div><div class="cm-val">${fmtCur(o.tt)}</div><div class="cm-sub">YoY ${fmtPct(o.tyoy25)}</div></div>
        <div class="cm"><div class="cm-label">Marketing</div><div class="cm-val">${fmtCur(o.tm)}</div><div class="cm-sub">YoY ${fmtPct(o.myoy25)}</div></div>
        <div class="cm"><div class="cm-label">Share Gap</div><div class="cm-val" style="color:${o.sg>5?'var(--red)':o.sg>2?'var(--amber)':'var(--green)'}">${o.sg>0?'+':''}${o.sg.toFixed(1)}%</div><div class="cm-sub">vs benchmark</div></div>
      </div>
      <div class="card-action" style="border-left:3px solid ${actionColor(o.nba)}">
        <span class="action-text" style="color:${actionColor(o.nba)}">${o.nba}</span>
        <div class="card-act-btns">
          ${ORG_ACTIONS_SET.has(o.organizer)?`<span class="act-done">‚úÖ</span>`:`<button class="act-btn" onclick="event.stopPropagation();logOrgAction('${o.organizer.replace(/'/g,"\\'")}','worked_on')">Worked on it</button>`}
          <button class="act-btn act-btn-sm" onclick="event.stopPropagation();const n=prompt('Add note for ${o.organizer.replace(/'/g,"\\'")}:');if(n)logOrgAction('${o.organizer.replace(/'/g,"\\'")}','note',n)">üìù</button>
        </div>
      </div>
      ${o.tags.length?`<div class="card-tags">${o.tags.map(t=>`<span class="tag-sm">${t}</span>`).join('')}</div>`:''}
    </div>`;
  });
  html+='</div>';
  document.getElementById('oppCards').innerHTML=html;

  // Pagination
  let pagHtml=`<div class="pag-info">Showing ${start+1}-${Math.min(start+perPage,list.length)} of ${list.length}</div><div class="pag-btns">`;
  pagHtml+=`<button class="pag-btn" ${oppPage===0?'disabled':''} onclick="oppPage--;renderOppCards()">‚Üê Prev</button>`;
  for(let i=0;i<Math.min(totalPages,7);i++){
    const pg=totalPages<=7?i:oppPage<3?i:oppPage>totalPages-4?totalPages-7+i:oppPage-3+i;
    pagHtml+=`<button class="pag-btn ${pg===oppPage?'active':''}" onclick="oppPage=${pg};renderOppCards()">${pg+1}</button>`;
  }
  pagHtml+=`<button class="pag-btn" ${oppPage>=totalPages-1?'disabled':''} onclick="oppPage++;renderOppCards()">Next ‚Üí</button></div>`;
  document.getElementById('oppPag').innerHTML=pagHtml;
}

/* ===== PERFORMANCE TAB ===== */
function renderPerf(){
  const p=document.getElementById('pane-performance');
  // By country
  const byCountry={};
  ORGS.forEach(o=>{
    if(!byCountry[o.country])byCountry[o.country]={tick:0,mkt:0,rp:0,cnt:0};
    byCountry[o.country].tick+=o.tt;byCountry[o.country].mkt+=o.tm;byCountry[o.country].rp+=(o.rp||0);byCountry[o.country].cnt++;
  });
  const sortedCountries=Object.entries(byCountry).sort((a,b)=>b[1].tick-a[1].tick).slice(0,15);

  // By tier
  const byTier={};
  ORGS.forEach(o=>{
    if(!byTier[o.tier])byTier[o.tier]={tick:0,mkt:0,cnt:0,rp:0};
    byTier[o.tier].tick+=o.tt;byTier[o.tier].mkt+=o.tm;byTier[o.tier].rp+=(o.rp||0);byTier[o.tier].cnt++;
  });

  const avgPS=ORGS.length>0?(ORGS.reduce((s,o)=>s+o.ps,0)/ORGS.length).toFixed(0):0;
  const avgRS=ORGS.length>0?(ORGS.reduce((s,o)=>s+o.rs,0)/ORGS.length).toFixed(0):0;

  p.innerHTML=`
  <div class="kpi-row">
    <div class="kpi"><div class="kpi-label">Avg Priority Score</div><div class="kpi-val">${avgPS}</div><div class="kpi-sub">across ${ORGS.length} orgs</div></div>
    <div class="kpi"><div class="kpi-label">Avg Risk Score</div><div class="kpi-val" style="color:${avgRS>50?'var(--red)':'var(--amber)'}">${avgRS}</div></div>
    <div class="kpi"><div class="kpi-label">Countries</div><div class="kpi-val">${Object.keys(byCountry).length}</div></div>
    <div class="kpi"><div class="kpi-label">Declining Orgs</div><div class="kpi-val" style="color:var(--red)">${ORGS.filter(o=>o.gt==='decelerating').length}</div></div>
  </div>
  <div class="chart-grid">
    <div class="chart-box"><h3>Revenue by Country (Top 15)</h3><canvas id="chCountry"></canvas></div>
    <div class="chart-box"><h3>Revenue by Tier</h3><canvas id="chTier"></canvas></div>
    <div class="chart-box"><h3>Share Distribution</h3><canvas id="chShareDist"></canvas></div>
    <div class="chart-box"><h3>Priority vs Risk Heatmap</h3><canvas id="chHeat"></canvas></div>
  </div>
  <h3 style="margin-bottom:12px">‚ö†Ô∏è Accounts Needing Attention</h3>
  <div class="cards" id="perfAlerts"></div>`;

  // Country chart
  charts.country=new Chart(document.getElementById('chCountry'),{type:'bar',data:{labels:sortedCountries.map(c=>c[0]),datasets:[
    {label:'Ticketing',data:sortedCountries.map(c=>c[1].tick),backgroundColor:'rgba(59,130,246,0.7)',borderRadius:4},
    {label:'Marketing',data:sortedCountries.map(c=>c[1].mkt),backgroundColor:'rgba(16,185,129,0.7)',borderRadius:4}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8fa8b4'}}},scales:{x:{ticks:{color:'#5d7a86',maxRotation:45}},y:{ticks:{color:'#5d7a86',callback:v=>fmtCur(v)}}}}});

  // Tier chart
  const tierLabels=Object.keys(byTier).sort();
  charts.tier=new Chart(document.getElementById('chTier'),{type:'bar',data:{labels:tierLabels,datasets:[
    {label:'Ticketing',data:tierLabels.map(t=>byTier[t].tick),backgroundColor:'rgba(59,130,246,0.7)',borderRadius:4},
    {label:'Marketing',data:tierLabels.map(t=>byTier[t].mkt),backgroundColor:'rgba(16,185,129,0.7)',borderRadius:4},
    {label:'Potential',data:tierLabels.map(t=>byTier[t].rp),backgroundColor:'rgba(139,92,246,0.4)',borderRadius:4}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8fa8b4'}}},scales:{x:{ticks:{color:'#5d7a86'}},y:{ticks:{color:'#5d7a86',callback:v=>fmtCur(v)}}}}});

  // Share distribution histogram
  const shareBuckets={'0%':0,'0-1%':0,'1-3%':0,'3-5%':0,'5-10%':0,'10%+':0};
  ORGS.forEach(o=>{const s=o.ts;if(s===0)shareBuckets['0%']++;else if(s<1)shareBuckets['0-1%']++;else if(s<3)shareBuckets['1-3%']++;else if(s<5)shareBuckets['3-5%']++;else if(s<10)shareBuckets['5-10%']++;else shareBuckets['10%+']++;});
  charts.shareDist=new Chart(document.getElementById('chShareDist'),{type:'bar',data:{labels:Object.keys(shareBuckets),datasets:[{data:Object.values(shareBuckets),backgroundColor:['#6b7280','#EF4444','#F59E0B','#79E2FF','#C7F88A','#8B5CF6'],borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#5d7a86'}},y:{ticks:{color:'#5d7a86'}}}}}); 

  // Priority vs Risk scatter
  const sample=ORGS.filter(o=>o.ps>30||o.rs>30);
  charts.heat=new Chart(document.getElementById('chHeat'),{type:'scatter',data:{datasets:[{data:sample.map(o=>({x:o.ps,y:o.rs})),backgroundColor:sample.map(o=>o.sr==='hot'?'rgba(239,68,68,0.7)':o.sr==='warm'?'rgba(245,158,11,0.7)':'rgba(59,130,246,0.4)'),pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>{const o=sample[ctx.dataIndex];return`${o.organizer}: PS=${o.ps}, RS=${o.rs}`;}}}},scales:{x:{title:{display:true,text:'Priority Score ‚Üí',color:'#8fa8b4'},ticks:{color:'#5d7a86'}},y:{title:{display:true,text:'Risk Score ‚Üí',color:'#8fa8b4'},ticks:{color:'#5d7a86'}}}}}); 

  // Alert cards
  const alerts=ORGS.filter(o=>o.rs>60||o.gt==='decelerating').sort((a,b)=>b.rs-a.rs).slice(0,12);
  const srCls={hot:'badge-hot',warm:'badge-warm',cold:'badge-cold',medium:'badge-medium'};
  document.getElementById('perfAlerts').innerHTML=alerts.map(o=>`<div class="card">
    <div class="card-head"><div class="card-name">${o.organizer}</div><div class="card-badges"><span class="badge ${srCls[o.sr]}">${o.sr}</span></div></div>
    <div class="card-meta"><span class="meta-pill">${o.country}</span><span class="meta-pill">Risk: ${o.rs}/100</span></div>
    <div class="card-action" style="border-left:3px solid var(--red)"><span class="action-text" style="color:var(--red)">${o.nba}</span></div>
  </div>`).join('');
}

/* ===== RAW DATA TAB ===== */
let rawView='orgs',rawPage=0,rawSort={col:'ps',asc:false},rawSearch='';
function renderRaw(){
  const p=document.getElementById('pane-raw');
  p.innerHTML=`
  <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
    <button class="pag-btn ${rawView==='orgs'?'active':''}" onclick="rawView='orgs';rawPage=0;renderRawTable()">Organisers</button>
    <button class="pag-btn ${rawView==='events'?'active':''}" onclick="rawView='events';rawPage=0;renderRawTable()">Events</button>
    <input placeholder="Search..." style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px;flex:1" oninput="rawSearch=this.value.toLowerCase();rawPage=0;renderRawTable()">
    <button class="btn-export" onclick="sess.exports++;logAction('export','csv_raw','raw');exportRawCSV()">üì• Export CSV</button>
  </div>
  <div class="tbl-wrap" id="rawTbl"></div>
  <div class="pag" id="rawPag"></div>`;
  renderRawTable();
}

function renderRawTable(){
  const perPage=50;
  if(rawView==='orgs'){
    let list=ORGS;
    if(rawSearch)list=list.filter(o=>o.organizer.toLowerCase().includes(rawSearch)||o.country.toLowerCase().includes(rawSearch));
    list=[...list].sort((a,b)=>{const v=rawSort.asc?1:-1;const av=a[rawSort.col],bv=b[rawSort.col];if(typeof av==='string')return av.localeCompare(bv)*v;return((av||0)-(bv||0))*v;});
    const start=rawPage*perPage;
    const page=list.slice(start,start+perPage);
    const cols=[
      {k:'organizer',l:'Organiser'},{k:'country',l:'Country'},{k:'tier',l:'Tier'},{k:'stage',l:'Stage'},
      {k:'ps',l:'Priority'},{k:'rp',l:'Rev Potential'},{k:'rs',l:'Risk'},{k:'sr',l:'Readiness'},
      {k:'tt',l:'Total Tick'},{k:'tm',l:'Total Mkt'},{k:'ts',l:'Total Share%'},
      {k:'sg',l:'Share Gap'},{k:'gt',l:'Trajectory'},{k:'lc',l:'Lifecycle'},{k:'nba',l:'Next Action'},
      {k:'t25',l:'Tick 2025'},{k:'m25',l:'Mkt 2025'},{k:'s25',l:'Share 2025'},
      {k:'tyoy25',l:'Tick YoY%'},{k:'myoy25',l:'Mkt YoY%'}
    ];
    let html=`<table><thead><tr>${cols.map(c=>`<th onclick="rawSort={col:'${c.k}',asc:rawSort.col==='${c.k}'?!rawSort.asc:false};renderRawTable()">${c.l}${rawSort.col===c.k?(rawSort.asc?' ‚Üë':' ‚Üì'):''}</th>`).join('')}</tr></thead><tbody>`;
    page.forEach(o=>{
      html+=`<tr>${cols.map(c=>{
        const v=o[c.k];
        if(c.k==='rp')return`<td style="color:var(--green)">${fmtCur(v)}</td>`;
        if(c.k==='ps')return`<td style="color:${v>=70?'var(--green)':v>=50?'var(--amber)':'var(--text2)'}">${v}</td>`;
        if(c.k==='rs')return`<td style="color:${v>70?'var(--red)':v>40?'var(--amber)':'var(--green)'}">${v}</td>`;
        if(c.k==='sr')return`<td><span class="badge badge-${v}">${v}</span></td>`;
        if(['tt','tm','t25','m25'].includes(c.k))return`<td>${fmtCur(v)}</td>`;
        if(['ts','s25','sg'].includes(c.k))return`<td>${v!=null?v.toFixed(1)+'%':'-'}</td>`;
        if(['tyoy25','myoy25'].includes(c.k))return`<td style="color:${v>0?'var(--green)':v<0?'var(--red)':'var(--text2)'}">${fmtPct(v)}</td>`;
        return`<td>${v||'-'}</td>`;
      }).join('')}</tr>`;
    });
    html+='</tbody></table>';
    document.getElementById('rawTbl').innerHTML=html;
    renderRawPag(list.length,perPage);
  } else {
    let list=EVENTS;
    if(rawSearch)list=list.filter(e=>e.name.toLowerCase().includes(rawSearch)||e.org.toLowerCase().includes(rawSearch));
    const start=rawPage*perPage;
    const page=list.slice(start,start+perPage);
    let html=`<table><thead><tr><th>Event</th><th>Organiser</th><th>Country</th><th>Year</th><th>Revenue</th><th>Marketing</th><th>Share%</th></tr></thead><tbody>`;
    page.forEach(e=>{
      html+=`<tr><td>${e.name}</td><td>${e.org}</td><td>${e.country}</td><td>${e.year||'-'}</td><td>${fmtCur(e.rev)}</td><td>${fmtCur(e.mkt)}</td><td>${e.share?e.share.toFixed(1)+'%':'-'}</td></tr>`;
    });
    html+='</tbody></table>';
    document.getElementById('rawTbl').innerHTML=html;
    renderRawPag(list.length,perPage);
  }
}

function renderRawPag(total,perPage){
  const totalPages=Math.ceil(total/perPage);
  let html=`<div class="pag-info">Showing ${rawPage*perPage+1}-${Math.min((rawPage+1)*perPage,total)} of ${total}</div><div class="pag-btns">`;
  html+=`<button class="pag-btn" ${rawPage===0?'disabled':''} onclick="rawPage--;renderRawTable()">‚Üê Prev</button>`;
  html+=`<button class="pag-btn" ${rawPage>=totalPages-1?'disabled':''} onclick="rawPage++;renderRawTable()">Next ‚Üí</button></div>`;
  document.getElementById('rawPag').innerHTML=html;
}

/* EXPORT */
function exportCSV(){
  const list=getFilteredOrgs();
  const cols=['organizer','country','tier','stage','type','ps','rp','rs','sr','gt','lc','sg','nba','tt','tm','ts','t23','m23','t24','m24','t25','m25','t26','m26','s23','s24','s25','s26','tyoy24','myoy24','tyoy25','myoy25'];
  let csv=cols.join(',')+String.fromCharCode(10);
  list.forEach(o=>{csv+=cols.map(c=>{const v=o[c];return typeof v==='string'&&v.includes(',')?'"'+v+'"':v??''}).join(',')+String.fromCharCode(10);});
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='paid_marketing_export.csv';a.click();
}
function exportRawCSV(){
  if(rawView==='orgs')exportCSV();
  else{
    const cols=['name','org','country','type','year','rev','mkt','share'];
    let csv=cols.join(',')+String.fromCharCode(10);
    EVENTS.forEach(e=>{csv+=cols.map(c=>{const v=e[c];return typeof v==='string'&&v.includes(',')?'"'+v+'"':v??''}).join(',')+String.fromCharCode(10);});
    const blob=new Blob([csv],{type:'text/csv'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='events_export.csv';a.click();
  }
}

/* ========== SUPABASE + LOGGING + ACHIEVEMENTS ========== */
const SB_URL='https://kwftlkfvtglnugxsyjci.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3ZnRsa2Z2dGdsbnVneHN5amNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2NDAxODUsImV4cCI6MjA2MzIxNjE4NX0.9Cn1xahmF8q6pbbWQHNyQSc9fZkVvJaqTzMRZCtmb9E';
let sb=null;
try{sb=supabase.createClient(SB_URL,SB_KEY);}catch(e){console.warn('Supabase init failed',e);}

/* Session tracking */
let sess={tabs:new Set(),filters:0,searches:0,exports:0,orgsViewed:0,loginTime:null,actions:[]};
let userAch=new Set();
let allAch=[];

async function logVisit(){
  if(!sb||!curUser)return;
  try{
    await sb.from('dashboard_visits').insert({
      user_id:curUser.id, user_name:curUser.name,
      user_agent:navigator.userAgent,
      screen_width:window.innerWidth, screen_height:window.innerHeight
    });
  }catch(e){console.warn('logVisit err',e);}
}

async function logAction(type,detail,tab){
  if(!sb||!curUser)return;
  sess.actions.push({type,detail,tab,time:new Date()});
  try{
    await sb.from('dashboard_actions').insert({
      user_id:curUser.id, user_name:curUser.name,
      action_type:type, action_detail:detail||'', tab:tab||''
    });
  }catch(e){console.warn('logAction err',e);}
  checkAchievements();
}

async function loadAchievements(){
  if(!sb)return;
  try{
    const {data}=await sb.from('dashboard_achievements').select('*').order('sort_order');
    if(data)allAch=data;
    const {data:ua}=await sb.from('dashboard_user_achievements').select('achievement_id').eq('user_id',curUser.id);
    if(ua)ua.forEach(r=>userAch.add(r.achievement_id));
    updateAchBadge();
  }catch(e){console.warn('loadAch err',e);}
}

function updateAchBadge(){
  const el=document.getElementById('achCountBadge');
  if(el)el.textContent=userAch.size;
  const sub=document.getElementById('achSub');
  if(sub)sub.textContent=userAch.size+' / '+allAch.length+' unlocked';
}

async function unlockAchievement(id){
  if(userAch.has(id)||!sb||!curUser)return;
  userAch.add(id);
  updateAchBadge();
  try{
    await sb.from('dashboard_user_achievements').insert({user_id:curUser.id,achievement_id:id});
  }catch(e){console.warn('unlock err',e);}
  const ach=allAch.find(a=>a.id===id);
  if(ach)showToast(ach.icon,ach.title,ach.description);
}

function checkAchievements(){
  if(!allAch.length)return;
  // first_login
  if(!userAch.has('first_login'))unlockAchievement('first_login');
  // visits_5 (check via action count as proxy)
  const totalActions=sess.actions.length;
  if(totalActions>=5&&!userAch.has('visits_5'))unlockAchievement('visits_5');
  if(totalActions>=25&&!userAch.has('visits_25'))unlockAchievement('visits_25');
  if(totalActions>=100&&!userAch.has('visits_100'))unlockAchievement('visits_100');
  // all_tabs
  if(sess.tabs.size>=5&&!userAch.has('all_tabs'))unlockAchievement('all_tabs');
  // filter_master
  if(sess.filters>=10&&!userAch.has('filter_master'))unlockAchievement('filter_master');
  // exports
  if(sess.exports>=1&&!userAch.has('first_export'))unlockAchievement('first_export');
  if(sess.exports>=10&&!userAch.has('exports_10'))unlockAchievement('exports_10');
  // searches
  if(sess.searches>=50&&!userAch.has('searched_50'))unlockAchievement('searched_50');
  // pipeline_view
  if(sess.tabs.has('pipeline')&&!userAch.has('pipeline_view'))unlockAchievement('pipeline_view');
  // viewed_hot
  const viewedHot=sess.actions.some(a=>a.type==='view_filter'&&a.detail==='hot');
  if(viewedHot&&!userAch.has('viewed_hot'))unlockAchievement('viewed_hot');
  // viewed_risk
  const viewedRisk=sess.actions.some(a=>a.type==='view_filter'&&a.detail==='risk');
  if(viewedRisk&&!userAch.has('viewed_risk'))unlockAchievement('viewed_risk');
  // early_bird / night_owl
  const hour=new Date().getHours();
  if(hour<7&&!userAch.has('early_bird'))unlockAchievement('early_bird');
  if(hour>=23&&!userAch.has('night_owl'))unlockAchievement('night_owl');
  // whale_watcher
  const viewedWhale=sess.actions.some(a=>a.type==='view_filter'&&a.detail&&a.detail.includes('whale'));
  if(viewedWhale&&!userAch.has('whale_watcher'))unlockAchievement('whale_watcher');
  // speed_demon - 3 tabs in 10s
  const tabActions=sess.actions.filter(a=>a.type==='switch_tab');
  if(tabActions.length>=3){
    const last3=tabActions.slice(-3);
    const diff=(last3[2].time-last3[0].time)/1000;
    if(diff<10&&!userAch.has('speed_demon'))unlockAchievement('speed_demon');
  }
  // tag_collector
  const tagActions=sess.actions.filter(a=>a.type==='filter_tag');
  const uniqueTags=new Set(tagActions.map(a=>a.detail));
  if(uniqueTags.size>=5&&!userAch.has('tag_collector'))unlockAchievement('tag_collector');
  // country_hopper
  const countryActions=sess.actions.filter(a=>a.type==='filter_country');
  const uniqueCountries=new Set(countryActions.map(a=>a.detail));
  if(uniqueCountries.size>=3&&!userAch.has('country_hopper'))unlockAchievement('country_hopper');
}

function showToast(icon,title,desc){
  const wrap=document.getElementById('toastWrap');
  if(!wrap)return;
  const t=document.createElement('div');
  t.className='toast';
  t.innerHTML=`<div class="toast-icon">${icon}</div><div class="toast-text"><div class="toast-title">üèÜ ${title}</div><div>${desc}</div></div>`;
  wrap.appendChild(t);
  setTimeout(()=>t.remove(),4500);
}

function toggleAch(){
  const ov=document.getElementById('achOverlay');
  ov.classList.toggle('open');
  if(ov.classList.contains('open'))renderAchPanel();
}

function renderAchPanel(){
  const grid=document.getElementById('achGrid');
  if(!grid||!allAch.length)return;
  grid.innerHTML=allAch.map(a=>{
    const unlocked=userAch.has(a.id);
    return `<div class="ach-item ${unlocked?'unlocked':'locked'}">
      <div class="ach-icon">${a.icon}</div>
      <div class="ach-info">
        <div class="ach-title">${a.title}</div>
        <div class="ach-desc">${a.description}</div>
        ${unlocked?'<div class="ach-time">‚úÖ Unlocked</div>':''}
      </div>
    </div>`;
  }).join('');
}

/* ===== ACTIVITY TAB ===== */
async function renderActivity(){
  const p=document.getElementById('pane-activity');
  if(!p)return;
  let html='<h3 style="margin-bottom:16px">üìã Recent Activity</h3>';
  if(!sb){p.innerHTML=html+'<p style="color:var(--text2)">Activity tracking unavailable</p>';return;}
  try{
    const {data:visits}=await sb.from('dashboard_visits').select('*').eq('user_id',curUser.id).order('logged_in_at',{ascending:false}).limit(20);
    const {data:actions}=await sb.from('dashboard_actions').select('*').eq('user_id',curUser.id).order('created_at',{ascending:false}).limit(50);

    html+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">`;
    html+=`<div class="seg-card"><h3>üîë Recent Logins (${(visits||[]).length})</h3>`;
    (visits||[]).forEach(v=>{
      const d=new Date(v.logged_in_at);
      html+=`<div class="seg-row"><span>${d.toLocaleDateString()} ${d.toLocaleTimeString()}</span><span>${v.screen_width}x${v.screen_height}</span></div>`;
    });
    html+=`</div>`;

    html+=`<div class="seg-card"><h3>‚ö° Recent Actions (${(actions||[]).length})</h3>`;
    const actionIcons={switch_tab:'üìë',filter_country:'üåç',filter_tier:'üìä',filter_stage:'üè∑Ô∏è',filter_tag:'üîñ',view_filter:'üëÅÔ∏è',search:'üîç',export:'üì•',login:'üîë'};
    (actions||[]).forEach(a=>{
      const d=new Date(a.created_at);
      const icon=actionIcons[a.action_type]||'‚ö°';
      html+=`<div class="seg-row"><span>${icon} ${a.action_type}: ${a.action_detail||'-'}</span><span style="color:var(--text3)">${d.toLocaleTimeString()}</span></div>`;
    });
    html+=`</div></div>`;

    // Achievement summary
    html+=`<div class="seg-card" style="margin-top:16px"><h3>üèÜ Achievements: ${userAch.size} / ${allAch.length}</h3>`;
    const catCounts={};
    allAch.forEach(a=>{
      if(!catCounts[a.category])catCounts[a.category]={total:0,unlocked:0};
      catCounts[a.category].total++;
      if(userAch.has(a.id))catCounts[a.category].unlocked++;
    });
    Object.entries(catCounts).forEach(([cat,c])=>{
      const pct=Math.round(c.unlocked/c.total*100);
      html+=`<div class="seg-row"><span>${cat}</span><span>${c.unlocked}/${c.total} (${pct}%)</span></div>`;
    });
    html+='</div>';

    p.innerHTML=html;
  }catch(e){
    p.innerHTML=html+'<p style="color:var(--text2)">Error loading activity: '+e.message+'</p>';
  }
}

/* ===== ASSIGN FUNCTIONS ===== */
function assignTask(type,id,assignee){
  if(type==='org')orgAssign[id]=assignee;
  else evtAssign[id]=assignee;
  logAction('assign_task',type+':'+id,assignee);
  if(type==='org')renderOrganisers();
  else renderEvents();
}

function showAssignMenu(type,id,btn){
  const existing=document.querySelector('.assign-menu');
  if(existing)existing.remove();
  if(curUser.id==='mohammed'){assignTask(type,id,'Mohammed Abdelnour');return;}
  if(curUser.id==='kamila'){assignTask(type,id,'Kamila');return;}
  const menu=document.createElement('div');
  menu.className='assign-menu';
  menu.style.cssText='position:absolute;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:4px;z-index:999;min-width:180px;';
  menu.innerHTML=`
    <div style="padding:8px 12px;cursor:pointer;border-radius:6px;font-size:13px" onmouseover="this.style.background='var(--surface3)'" onmouseout="this.style.background=''" onclick="assignTask('${type}','${id}','Mohammed Abdelnour');this.parentElement.remove()">Mohammed Abdelnour</div>
    <div style="padding:8px 12px;cursor:pointer;border-radius:6px;font-size:13px" onmouseover="this.style.background='var(--surface3)'" onmouseout="this.style.background=''" onclick="assignTask('${type}','${id}','Kamila');this.parentElement.remove()">Kamila</div>
  `;
  btn.style.position='relative';
  btn.parentElement.style.position='relative';
  btn.parentElement.appendChild(menu);
  setTimeout(()=>document.addEventListener('click',function rm(){menu.remove();document.removeEventListener('click',rm);},{once:true}),10);
}

/* ===== ORGANISERS TAB ===== */
function renderOrganisers(){
  const p=document.getElementById('pane-organisers');
  p.innerHTML=`
  <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
    <h3 style="flex:none;font-size:16px">üìä Organisers (${ORGS.length})</h3>
    <input placeholder="Search organisers..." style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px;flex:1" value="${orgListSearch}" oninput="orgListSearch=this.value.toLowerCase();orgListPage=0;renderOrgTable()">
    <button class="btn-export" onclick="exportOrgCSV()">üì• Export CSV</button>
  </div>
  <div class="tbl-wrap" id="orgTbl"></div>
  <div class="pag" id="orgPag"></div>`;
  renderOrgTable();
}

function renderOrgTable(){
  const perPage=50;
  let list=ORGS;
  if(orgListSearch)list=list.filter(o=>o.organizer.toLowerCase().includes(orgListSearch)||o.country.toLowerCase().includes(orgListSearch)||(o.tier||'').toLowerCase().includes(orgListSearch));
  list=[...list].sort((a,b)=>{const v=orgListSort.asc?1:-1;const av=a[orgListSort.col],bv=b[orgListSort.col];if(typeof av==='string')return(av||'').localeCompare(bv||'')*v;return((av||0)-(bv||0))*v;});
  const start=orgListPage*perPage;
  const page=list.slice(start,start+perPage);
  const total=list.length;
  const totalPages=Math.ceil(total/perPage);
  const cols=[
    {k:'organizer',l:'Organiser'},{k:'country',l:'Country'},{k:'tier',l:'Tier'},{k:'stage',l:'Stage'},{k:'type',l:'Type'},
    {k:'ps',l:'Priority'},{k:'rp',l:'Rev Potential'},{k:'rs',l:'Risk'},{k:'sr',l:'Readiness'},
    {k:'tt',l:'Total Tick'},{k:'tm',l:'Total Mkt'},{k:'ts',l:'Share%'},
    {k:'sg',l:'Share Gap'},{k:'gt',l:'Trajectory'},{k:'lc',l:'Lifecycle'},{k:'nba',l:'NBA'},
    {k:'t25',l:'Tick 25'},{k:'m25',l:'Mkt 25'},{k:'s25',l:'Share 25'},
    {k:'_assign',l:'Assign'}
  ];
  let html=`<table><thead><tr>${cols.map(c=>c.k==='_assign'?`<th>Assign</th>`:`<th onclick="orgListSort={col:'${c.k}',asc:orgListSort.col==='${c.k}'?!orgListSort.asc:false};renderOrgTable()">${c.l}${orgListSort.col===c.k?(orgListSort.asc?' ‚Üë':' ‚Üì'):''}</th>`).join('')}</tr></thead><tbody>`;
  page.forEach(o=>{
    const assignee=orgAssign[o.organizer];
    html+=`<tr>${cols.map(c=>{
      if(c.k==='_assign'){
        if(assignee)return`<td><span class="assign-badge">${assignee}</span></td>`;
        return`<td><button class="assign-btn" onclick="showAssignMenu('org',\`${o.organizer.replace(/`/g,'')}\`,this)">Assign</button></td>`;
      }
      const v=o[c.k];
      if(c.k==='rp')return`<td style="color:var(--green)">${fmtCur(v)}</td>`;
      if(c.k==='ps')return`<td style="color:${v>=70?'var(--green)':v>=50?'var(--amber)':'var(--text2)'}">${v}</td>`;
      if(c.k==='rs')return`<td style="color:${v>70?'var(--red)':v>40?'var(--amber)':'var(--green)'}">${v}</td>`;
      if(c.k==='sr')return`<td><span class="badge badge-${v}">${v}</span></td>`;
      if(['tt','tm','t25','m25'].includes(c.k))return`<td>${fmtCur(v)}</td>`;
      if(['ts','s25','sg'].includes(c.k))return`<td>${v!=null?v.toFixed(1)+'%':'-'}</td>`;
      return`<td>${v||'-'}</td>`;
    }).join('')}</tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('orgTbl').innerHTML=html;
  let pagHtml=`<span style="color:var(--text2);font-size:13px">Showing ${start+1}-${Math.min(start+perPage,total)} of ${total}</span><div style="display:flex;gap:4px">`;
  if(orgListPage>0)pagHtml+=`<button class="pag-btn" onclick="orgListPage--;renderOrgTable()">‚Üê Prev</button>`;
  pagHtml+=`<span class="pag-btn active">Page ${orgListPage+1}/${totalPages}</span>`;
  if(orgListPage<totalPages-1)pagHtml+=`<button class="pag-btn" onclick="orgListPage++;renderOrgTable()">Next ‚Üí</button>`;
  pagHtml+=`</div>`;
  document.getElementById('orgPag').innerHTML=pagHtml;
}

/* ===== EVENTS TAB ===== */
function renderEvents(){
  const p=document.getElementById('pane-events');
  p.innerHTML=`
  <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
    <h3 style="flex:none;font-size:16px">üé´ Events (${EVENTS.length})</h3>
    <input placeholder="Search events..." style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px;flex:1" value="${evtListSearch}" oninput="evtListSearch=this.value.toLowerCase();evtListPage=0;renderEvtTable()">
    <button class="btn-export" onclick="exportEvtCSV()">üì• Export CSV</button>
  </div>
  <div class="tbl-wrap" id="evtTbl"></div>
  <div class="pag" id="evtPag"></div>`;
  renderEvtTable();
}

function renderEvtTable(){
  const perPage=50;
  let list=EVENTS;
  if(evtListSearch)list=list.filter(e=>(e.name||'').toLowerCase().includes(evtListSearch)||(e.org||'').toLowerCase().includes(evtListSearch)||(e.country||'').toLowerCase().includes(evtListSearch));
  list=[...list].sort((a,b)=>{const v=evtListSort.asc?1:-1;const av=a[evtListSort.col],bv=b[evtListSort.col];if(typeof av==='string')return(av||'').localeCompare(bv||'')*v;return((av||0)-(bv||0))*v;});
  const start=evtListPage*perPage;
  const page=list.slice(start,start+perPage);
  const total=list.length;
  const totalPages=Math.ceil(total/perPage);
  const cols=[
    {k:'name',l:'Event Name'},{k:'org',l:'Organiser'},{k:'country',l:'Country'},{k:'type',l:'Type'},
    {k:'id',l:'Event ID'},{k:'date',l:'Date'},{k:'year',l:'Year'},
    {k:'rev',l:'Revenue'},{k:'mkt',l:'Marketing'},{k:'share',l:'Share%'},
    {k:'_assign',l:'Assign'}
  ];
  let html=`<table><thead><tr>${cols.map(c=>c.k==='_assign'?`<th>Assign</th>`:`<th onclick="evtListSort={col:'${c.k}',asc:evtListSort.col==='${c.k}'?!evtListSort.asc:false};renderEvtTable()">${c.l}${evtListSort.col===c.k?(evtListSort.asc?' ‚Üë':' ‚Üì'):''}</th>`).join('')}</tr></thead><tbody>`;
  page.forEach(e=>{
    const assignee=evtAssign[e.id];
    html+=`<tr>${cols.map(c=>{
      if(c.k==='_assign'){
        if(assignee)return`<td><span class="assign-badge">${assignee}</span></td>`;
        return`<td><button class="assign-btn" onclick="showAssignMenu('evt','${e.id}',this)">Assign</button></td>`;
      }
      const v=e[c.k];
      if(c.k==='rev'||c.k==='mkt')return`<td>${fmtCur(v)}</td>`;
      if(c.k==='share')return`<td>${v!=null?(v*100).toFixed(1)+'%':'-'}</td>`;
      return`<td>${v||'-'}</td>`;
    }).join('')}</tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('evtTbl').innerHTML=html;
  let pagHtml=`<span style="color:var(--text2);font-size:13px">Showing ${start+1}-${Math.min(start+perPage,total)} of ${total}</span><div style="display:flex;gap:4px">`;
  if(evtListPage>0)pagHtml+=`<button class="pag-btn" onclick="evtListPage--;renderEvtTable()">‚Üê Prev</button>`;
  pagHtml+=`<span class="pag-btn active">Page ${evtListPage+1}/${totalPages}</span>`;
  if(evtListPage<totalPages-1)pagHtml+=`<button class="pag-btn" onclick="evtListPage++;renderEvtTable()">Next ‚Üí</button>`;
  pagHtml+=`</div>`;
  document.getElementById('evtPag').innerHTML=pagHtml;
}

/* ===== EXPORT FUNCTIONS ===== */
function exportOrgCSV(){
  sess.exports++;logAction('export','csv_organisers','organisers');
  const cols=['organizer','country','tier','stage','type','ps','rp','rs','sr','tt','tm','ts','sg','gt','lc','nba','t25','m25','s25'];
  const header=cols.join(',');
  const rows=ORGS.map(o=>cols.map(c=>{const v=o[c];return typeof v==='string'?'"'+v.replace(/"/g,'""')+'"':v??''}).join(','));
  const csv=header+'\n'+rows.join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='organisers_export.csv';a.click();
}

function exportEvtCSV(){
  sess.exports++;logAction('export','csv_events','events');
  const cols=['name','org','country','type','id','date','year','rev','mkt','share'];
  const header=cols.join(',');
  const rows=EVENTS.map(e=>cols.map(c=>{const v=e[c];return typeof v==='string'?'"'+v.replace(/"/g,'""')+'"':v??''}).join(','));
  const csv=header+'\n'+rows.join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='events_export.csv';a.click();
}
</script>
</body>
</html>